<%
topics_only = defined?(topics_only) ? topics_only : false

# These queries uses zoom and aren't cached
@total_item_counts = 0
conditions = "(content_item_relations.related_item_id = :cache_id AND content_item_relations.related_item_type = '#{item.class.name}')"
conditions = "content_item_relations.topic_id = :cache_id OR #{conditions}" if params[:controller] == 'topics'
@content_relations_count = ContentItemRelation.count(:conditions => [conditions, { :cache_id => @cache_id }])
if @content_relations_count > 0
  @public_item_counts = public_related_items_for(item, { :topics_only => topics_only, :count_only => true })
  @private_item_counts = private_related_items_for(item, { :topics_only => topics_only, :count_only => true })
  @public_item_counts.each { |v| @total_item_counts += v.last }
  @private_item_counts.each { |v| @total_item_counts += v.last }

  # The public query uses mysql and is cached
  cache({ :related => 'public_query', :id => @cache_id }) do
    @public_items = public_related_items_for(item, { :topics_only => topics_only })
    "(this just ensures queries don't run when unless needed - ignore this file)"
  end
  # The private query uses zoom and isn't cached
  @private_items = private_related_items_for(item, { :topics_only => topics_only })
end
-%>

<% if topics_only -%>

  <%= render(:partial => "topics/secondary_wrapper_start",
             :locals => { :div_id => "related-link", :class_suffix => "-blue" }) -%>

  <%= render(:partial => "topics/related_items_section",
             :locals => { :item => item, :zoom_class => 'Topic',
                          :display_heading => "<h3>#{t('topics.related_items.related_topics')}</h3>",
                          :display_no_item_text => true }) -%>

  <%= render(:partial => "topics/secondary_wrapper_end") -%>

<% else -%>

  <%= render(:partial => "topics/secondary_wrapper_start",
             :locals => { :div_id => "related", :class_suffix => "-blue" }) -%>

  <h2 class="related-link">
    <%= link_to_related_items_of(item, 'Topic', :link_text => "#{t('topics.related_items.related_items')} (#{@total_item_counts})") -%>
  </h2>

  <% if current_user_can_see_add_links? -%>
    <div id="related-items-tools">
      <ul>
        <% cache({ :related => 'related-tools-create-or-link-or-remove', :id => @cache_id }) do -%>
          <%= header_add_links(:relate_to_topic => item, :related_topic_private => (params[:private] && params[:private] == 'true'), :link_text => t('topics.related_items.create'), :class => 'first') -%>
          <%= link_to_related_item_function(:link_text => t('topics.related_items.link_existing'), :function => 'add', :relate_to_topic => item) -%>
          <%= link_to_related_item_function(:link_text => t('topics.related_items.remove'), :function => 'remove', :relate_to_topic => item) -%>
        <% end -%>
        <% if @basket_moderator -%>
          <% cache({ :related => 'related-tools-restore', :id => @cache_id }) do -%>
            <%= link_to_related_item_function(:link_text => t('topics.related_items.restore'), :function => 'restore', :relate_to_topic => item) -%>
          <% end -%>
        <% end -%>
        <% if @site_admin -%>
          <% cache({ :related => 'related-tools-import', :id => @cache_id }) do -%>
            <%= link_to_add_set_of_related_items(:link_text => t('topics.related_items.import_set'), :relate_to_topic => item) -%>
          <% end -%>
        <% end -%>
      </ul>
    </div>
    <div style="clear:both;"></div>
  <% end -%>

  <div id="detail-linked-toprow">
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'StillImage' }) -%>
  </div>

  <div class="two-col">
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'Topic' }) -%>
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'AudioRecording' }) -%>
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'Video' }) -%>
    <div class="cleaner-left">&nbsp;</div>
  </div>

  <div class="two-col">
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'Document' }) -%>
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'WebLink' }) -%>
  </div>

  <%= render(:partial => "topics/secondary_wrapper_end") -%>

<% end -%>
