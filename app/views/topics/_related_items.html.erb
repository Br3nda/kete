<%
topics_only = defined?(topics_only) ? topics_only : false

# These queries uses zoom and aren't caches
@public_item_counts = public_related_items_for(item, { :topics_only => topics_only, :count_only => true })
@private_item_counts = private_related_items_for(item, { :topics_only => topics_only, :count_only => true })

# The public query uses mysql and is cached
cache({ :related => 'public_query', :id => @cache_id }) do
  @public_items = public_related_items_for(item, { :topics_only => topics_only })
  "(this just ensures queries don't run when unless needed - ignore this file)"
end
# The private query uses zoom and isn't cached
@private_items = private_related_items_for(item, { :topics_only => topics_only })

-%>

<% if topics_only -%>

  <%= render(:partial => "topics/secondary_wrapper_start",
             :locals => { :div_id => "related-link", :class_suffix => "-blue" }) -%>

  <%= render(:partial => "topics/related_items_section",
             :locals => { :item => item, :zoom_class => 'Topic',
                          :display_heading => '<h3>Related Topics:</h3>',
                          :display_no_item_text => true }) -%>

  <%= render(:partial => "topics/secondary_wrapper_end") -%>

<% else -%>

  <%= render(:partial => "topics/secondary_wrapper_start",
             :locals => { :div_id => "related", :class_suffix => "-blue" }) -%>

  <h2 class="related-link">Related Items</h2>

  <% if current_user_can_see_add_links? -%>
    <% cache({ :part => 'related-tools' }) do -%>
      <div id="related-items-tools">
        <ul>
          <%= header_add_links(:relate_to_topic => item, :link_text => 'Create', :class => 'first') -%>
          <%= link_to_related_item_function(:link_text => 'Link Existing', :function => 'add', :relate_to_topic => item) -%>
          <%= link_to_related_item_function(:link_text => 'Remove', :function => 'remove', :relate_to_topic => item) -%>
          <%= link_to_related_item_function(:link_text => 'Restore', :function => 'restore', :relate_to_topic => item) -%>
          <%= link_to_add_set_of_related_items(:link_text => 'Import Set', :relate_to_topic => item) -%>
        </ul>
      </div>
      <div style="clear:both;"></div>
    <% end -%>
  <% end -%>

  <div id="detail-linked-toprow">
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'StillImage' }) -%>
  </div>

  <div class="two-col">
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'Topic' }) -%>
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'AudioRecording' }) -%>
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'Video' }) -%>
    <div class="cleaner-left">&nbsp;</div>
  </div>

  <div class="two-col">
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'Document' }) -%>
    <%= render(:partial => "topics/related_items_section",
               :locals => { :item => item, :zoom_class => 'WebLink' }) -%>
  </div>

  <div style="clear:both;"></div>

  <%= render(:partial => "topics/secondary_wrapper_end") -%>

<% end -%>
